<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>How to build a RegExp? - benaryorg.github.io</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="benaryorg&#x27;s blag">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../legacy/index.html"><strong aria-hidden="true">2.</strong> Legacy</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.1.</strong> Programming</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../legacy/programming/getting_started.html"><strong aria-hidden="true">2.1.1.</strong> Getting Started With Programming</a></li><li class="chapter-item expanded "><a href="../../legacy/programming/plain_code.html"><strong aria-hidden="true">2.1.2.</strong> Plain Code</a></li><li class="chapter-item expanded "><a href="../../legacy/programming/a_to_b.html"><strong aria-hidden="true">2.1.3.</strong> A to B</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> Meta</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../legacy/meta/how_to_build_a_regexp.html" class="active"><strong aria-hidden="true">2.2.1.</strong> How to build a RegExp?</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">benaryorg.github.io</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-to-build-a-regexp"><a class="header" href="#how-to-build-a-regexp">How to build a RegExp?</a></h1>
<p>I see people abusing regexes just about every day.
If you're really good at regexes then you will certainly feel some sort of pain
as soon as you see <code>.*</code> or similar constructs in inappropriate places.</p>
<p>So here is my guide to doing it the right way.</p>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<p>I'm going to use PCRE all over the place.
My preferred syntax is <code>m{something}</code> and <code>s{a}{b}g</code> so I'll stick with those.</p>
<p>You can try all examples using:</p>
<pre><code class="language-bash"># for searches, just start typing, quit using ^D
perl -ne 'm{a(.)c} &amp;&amp; print &quot;$1\n&quot;'
# for replacements
perl -pe 's{a.c}{abc}g'
</code></pre>
<h2 id="why-not-use-"><a class="header" href="#why-not-use-">Why not use <code>.*</code>?</a></h2>
<p>You're looking for a needle in a haystack.
A practical example: you look for your favourite plushie in your room.</p>
<p>A nice regex for that would be <code>m{\bplushie\b}</code>.
It looks for your plushie as one word, meaning that it will match only if on
each side the word ends.
See also <a href="http://www.regular-expressions.info/wordboundaries.html">word
boundaries</a>.</p>
<p>What I see people do, which is completely ridiculous, is
<code>m{^.*\bplushie\b.*$}</code>.</p>
<p>Let me explain:</p>
<ul>
<li>They match the beginning of the line even though they don't need it.</li>
<li>They match the end of the line.</li>
<li>They let their parser go through all of the characters, even though they
already found what they were looking for.</li>
</ul>
<p>If you look for an occurrence somewhere, that does not need to be anywhere
specific then why are you looking at everything else?
You don't walk into your room and start looking from one side sequentially to
the other.
What you do is look in your room, see the plushie sitting on the bed and take
it.</p>
<h2 id="complex-examples"><a class="header" href="#complex-examples">Complex Examples</a></h2>
<p>Let's choose <em>fail2ban</em> as an example.
We want to block every IP sending more than 1000 HTTP requests per five
seconds.
I'll ignore how to configure <em>fail2ban</em> as it's not relevant to the regex
thing.</p>
<p>First try, without even looking at the format of the logs: <code>m{^.*&lt;HOST&gt;.*$}</code></p>
<p>You probably messed up very hard here.
To explain why you've messed up so hard, let's look at one line of logs:</p>
<pre><code class="language-text">10.0.0.1 - - [16/Jul/2017:15:38:54 +0200] &quot;GET /robots.txt HTTP/1.0&quot; 404 319 &quot;-&quot; &quot;Mozilla/5.0 (compatible; AhrefsBot/5.2; +http://ahrefs.com/robot/)&quot; &quot;-&quot;
</code></pre>
<p>I took that line out of my server, the <em>10.0.0.1</em> is the part that we want
(please ignore that it's an internal IP).</p>
<p><code>m{.*}</code> does greedy matching, so the above regex will be very easy to break.
Just put an IP in the User Agent.
The User Agent contains spaces as you might have noticed, which is fine as the
string is quoted (and <em>nginx</em> does some escaping on the contained string).
Now what'll happen if I put an IP address in the User Agent?
Right, due to greedy matching the rightmost <code>&lt;HOST&gt;</code> will match.
This will of course result in some serious problems.</p>
<p>As a malicious hacker I could:</p>
<ul>
<li>Circumvent <em>fail2ban</em> altogether by putting <code>127.0.0.1</code> into my User Agent.
That will effectively turn off <em>fail2ban</em> for my requests as long as
<code>127.0.0.1</code> is whitelisted. If that IP is not whitelisted, you've got
problems a lot worse (assuming <em>fail2ban</em> uses <em>iptables</em>, this will break at
least half of your server's software, think of accessing <em>MySQL</em> on
<em>localhost</em>).</li>
<li>Block arbitrary IPs from accessing your website in much the same way.</li>
</ul>
<p>So how are we going to construct a Regex that will match <strong>only</strong> what we're
looking for here?</p>
<p>Well, the IP is right at the start, so we'll take <code>m{^&lt;HOST&gt;.*$}</code> right?</p>
<p>Technically right, but I wouldn't write it that way.
That regex would again match everything after the IP, but <em>we really don't care
about that</em>.</p>
<p>What we should do is a simple <code>m{^&lt;HOST&gt;}</code>.
This works as intended and it does only look at the first few characters.
If you want to make sure that it's followed by a space, go ahead, please.</p>
<p>So we end up with a fool-proof regex: <code>m{^&lt;HOST&gt;\s}</code>.
This will for sure fulfill all our needs.</p>
<p>To be honest, this example is kind of easy as the IP is right at the start.
Let's assume some other format so we can work out a more general way for this
to work.</p>
<h3 id="copy-paste-replace"><a class="header" href="#copy-paste-replace">Copy, Paste, Replace</a></h3>
<p>We are going to perform CPR on a line of text.
As said above, this time we want to get something that is <em>not</em> right at the
start.
We'll look at the following line:</p>
<pre><code class="language-text">[16/Jul/2017:16:27:41 +0200] openbsd.cloud.bsocat.net - - 66.133.109.36 &quot;GET /.well-known/acme-challenge/tTRnUGY9gZEVz2llGWqn1m3mHznMDOFH3zCXsgelh7w HTTP/1.1&quot; 200 87
</code></pre>
<p>This is a slightly modified OpenBSD httpd log-format.
By <em>slightly</em> I mean:</p>
<ul>
<li>date and time moved to the front</li>
<li>host moved a bit backwards</li>
</ul>
<p>Now let's do this:</p>
<pre><code class="language-text"># copy the line, verbatim
[16/Jul/2017:16:27:41 +0200] openbsd.cloud.bsocat.net - - 66.133.109.36 &quot;GET /.well-known/acme-challenge/tTRnUGY9gZEVz2llGWqn1m3mHznMDOFH3zCXsgelh7w HTTP/1.1&quot; 200 87

# remove everything after the needle (except for the delimiter), we don't need it
[16/Jul/2017:16:27:41 +0200] openbsd.cloud.bsocat.net - - 66.133.109.36\s

# add needed meta-characters (start of line)
^[16/Jul/2017:16:27:41 +0200] openbsd.cloud.bsocat.net - - 66.133.109.36\s

# escape all the characters that need escaping
^\[16/Jul/2017:16:27:41 \+0200\] openbsd\.cloud\.bsocat\.net - - 66\.133\.109\.36\s

# replace the host
^\[16/Jul/2017:16:27:41 \+0200\] openbsd\.cloud\.bsocat\.net - - &lt;HOST&gt;\s

# replace everything that is not static by their possible values
# this requires a lot of in depth knowledge about the log format
# let's do this the easy way and just replace using dots for the date
^\[../.../....:..:..:.. .....\] openbsd\.cloud\.bsocat\.net - - &lt;HOST&gt;\s

# for the other fields we just specify them to &quot;not contain spaces&quot; as these
# are used for delimiting, so they will not occur in the fields
^\[../.../....:..:..:.. .....\] [^\s]+ [^\s]+ [^\s]+ &lt;HOST&gt;\s

# fail2ban needs spaces escaped I think
^\[../.../....:..:..:..\s.....\]\s[^\s]+\s[^\s]+\s[^\s]+\s&lt;HOST&gt;\s
</code></pre>
<h3 id="how-do-we-check"><a class="header" href="#how-do-we-check">How do we check?</a></h3>
<p>If it's <em>fail2ban</em>, just run that.
For everything else:</p>
<pre><code class="language-bash">perl -ne 'm{^\[../.../....:..:..:..\s.....\]\s[^\s]+\s[^\s]+\s[^\s]+\s([^\s]+)\s} &amp;&amp; print &quot;$1\n&quot;'
</code></pre>
<p>This should output only the IP we were looking for.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../legacy/programming/a_to_b.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../legacy/programming/a_to_b.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
